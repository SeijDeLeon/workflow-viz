# docker-compose.yml

version: "3"
services:
  tiled:
    container_name: tiled_workflow_server
    build: .
    command: bash -c "/app/tiled/tiled_config_serve.sh"
    volumes:
      - ./tiled:/app/tiled
      - ${PATH_TO_DATA_DESY}:/data
    environment:
      TILED_API_KEY: ${TILED_API_KEY}
      PATH_TO_DATA_CATALOG: "/app/tiled/db/catalog_docker.db"
    depends_on:
      - tiled-watch
    ports:
      - '8888:8888'
    networks:
      - workflow_viz_default

  tiled-watch:
    container_name: tiled_workflow_watcher
    build: .
    command: bash -c "/app/tiled/tiled_catalog_register.sh"
    volumes:
      - ./tiled:/app/tiled
      - ${PATH_TO_DATA_DESY}:/data
    environment:
      PATH_TO_DATA_DESY: "/data"
      PATH_TO_DATA_CATALOG: "/app/tiled/db/catalog_docker.db"
    networks:
      - workflow_viz_default

  workflow-viz:
    container_name: workflow_viz
    build: .
    command: 'python app.py'
    environment:
      TILED_API_KEY: ${TILED_API_KEY}
      TILED_URI: "http://tiled:8888"
      PREFECT_API_URL: "http://prefect-server:4200/api"
    volumes:
      - ./app.py:/app/app.py
      - ./callbacks:/app/callbacks
      - ./components:/app/components
      - ./utils:/app/utils
    ports:
      - '8095:8095'
    depends_on:
      - tiled
    networks:
      - workflow_viz_default

networks:
  workflow_viz_default:
    external: true
